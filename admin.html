<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Administrativo - MedAgenda-CR</title>
  <link rel="stylesheet" href="css/style.css?v=2.0">
</head>
<body>
  <!-- Header del panel admin -->
  <header class="admin-header">
    <div class="container">
      <div class="admin-header-content">
        <div>
          <h1>ğŸ¥ MedAgenda-CR</h1>
          <p class="admin-subtitle">Panel Administrativo</p>
        </div>
        <div class="admin-user-info">
          <span id="userEmail">ğŸ‘¤ Usuario</span>
          <button class="btn outline" onclick="cerrarSesion()">Cerrar sesiÃ³n</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Dashboard con estadÃ­sticas -->
  <section class="dashboard-stats">
    <div class="container">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“…</div>
          <div class="stat-info">
            <h3 id="totalCitas">0</h3>
            <p>Citas programadas</p>
          </div>
        </div>
        
        <div class="stat-card emergency">
          <div class="stat-icon">ğŸš¨</div>
          <div class="stat-info">
            <h3 id="citasEmergencia">0</h3>
            <p>Emergencias</p>
          </div>
        </div>
        
        <div class="stat-card urgent">
          <div class="stat-icon">âš ï¸</div>
          <div class="stat-info">
            <h3 id="citasUrgentes">0</h3>
            <p>Muy urgentes</p>
          </div>
        </div>
        
        <div class="stat-card waiting">
          <div class="stat-icon">â³</div>
          <div class="stat-info">
            <h3 id="pacientesEspera">0</h3>
            <p>En lista de espera</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Filtros y controles -->
  <section class="admin-filters">
    <div class="container">
      <div class="filters-row">
        <input type="text" id="filtroNombre" placeholder="ğŸ” Buscar por nombre..." onkeyup="filtrarCitas()">
        <input type="date" id="filtroFecha" onchange="filtrarCitas()">
        <select id="filtroPrioridad" onchange="filtrarCitas()">
          <option value="">Todas las prioridades</option>
          <option value="emergencia">ğŸ”´ Emergencia</option>
          <option value="muy-urgente">ğŸŸ  Muy urgente</option>
          <option value="urgente">ğŸŸ¡ Urgente</option>
          <option value="no-urgente">ğŸ”µ No urgente</option>
          <option value="control">âšª Control</option>
        </select>
        <button class="btn outline" onclick="filtrarCitas()">Aplicar filtros</button>
        <button class="btn outline" onclick="limpiarFiltros()">Limpiar</button>
      </div>
    </div>
  </section>

  <!-- Tabla de citas -->
  <section class="admin-table-section">
    <div class="container">
      <div class="section-header">
        <h2>ğŸ“‹ Citas programadas</h2>
        <div class="action-buttons">
          <button class="btn outline" onclick="exportarCitas()">ğŸ“¥ Exportar</button>
          <button class="btn outline" onclick="generarReporte()">ğŸ“Š Reporte</button>
          <button class="btn outline danger" onclick="limpiarTodasCitas()">ğŸ—‘ï¸ Limpiar todo</button>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="admin-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Paciente</th>
              <th>TelÃ©fono</th>
              <th>Fecha y hora</th>
              <th>Prioridad</th>
              <th>Score</th>
              <th>SÃ­ntomas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaCitas">
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px;">
                <p style="color: #999; font-size: 16px;">ğŸ“­ No hay citas programadas</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Lista de espera -->
  <section class="waiting-list-section">
    <div class="container">
      <h2>â³ Lista de espera</h2>
      <div id="listaEspera" class="waiting-list-grid">
        <p style="text-align: center; color: #999; padding: 40px;">
          No hay pacientes en lista de espera
        </p>
      </div>
    </div>
  </section>

  <!-- Modal para editar cita -->
  <div id="modalEditar" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>âœï¸ Editar cita</h3>
        <span class="close" onclick="cerrarModal()">&times;</span>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editarId">
        
        <label for="editarNombre">Nombre del paciente:</label>
        <input type="text" id="editarNombre" required>
        
        <label for="editarTelefono">TelÃ©fono:</label>
        <input type="tel" id="editarTelefono" required>
        
        <label for="editarFecha">Fecha:</label>
        <input type="date" id="editarFecha" required>
        
        <label for="editarHora">Hora:</label>
        <input type="time" id="editarHora" required>
        
        <label for="editarPrioridad">Prioridad:</label>
        <select id="editarPrioridad" required>
          <option value="emergencia">ğŸ”´ Emergencia</option>
          <option value="muy-urgente">ğŸŸ  Muy urgente</option>
          <option value="urgente">ğŸŸ¡ Urgente</option>
          <option value="no-urgente">ğŸ”µ No urgente</option>
          <option value="control">âšª Control</option>
        </select>
        
        <label for="editarSintomas">SÃ­ntomas:</label>
        <textarea id="editarSintomas" rows="3"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn outline" onclick="cerrarModal()">Cancelar</button>
        <button class="btn primary" onclick="guardarEdicion()">ğŸ’¾ Guardar cambios</button>
      </div>
    </div>
  </div>

  <!-- JavaScript INTERNO (NO usar script.js aquÃ­) -->
  <script>
    // ========================================
    // VERIFICACIÃ“N DE SESIÃ“N (PROTECCIÃ“N DE RUTA)
    // ========================================
    (function verificarSesion() {
      const estaLogueado = sessionStorage.getItem('medagenda_logged');
      const usuario = sessionStorage.getItem('medagenda_user');
      
      if (!estaLogueado || estaLogueado !== 'true') {
        alert('âš ï¸ Debes iniciar sesiÃ³n para acceder al panel administrativo');
        window.location.href = 'login.html';
        return;
      }
      
      if (usuario) {
        document.getElementById('userEmail').textContent = 'ğŸ‘¤ ' + usuario;
      }
    })();

    // ========================================
    // VARIABLES GLOBALES
    // ========================================
    let todasLasCitas = [];
    let citasFiltradas = [];
    let citaEditando = null;

    // ========================================
    // FUNCIONES DE ALMACENAMIENTO
    // ========================================
    function cargarCitas() {
      const citasGuardadas = localStorage.getItem('medagenda_appointments');
      if (citasGuardadas) {
        todasLasCitas = JSON.parse(citasGuardadas);
        citasFiltradas = [...todasLasCitas];
      } else {
        todasLasCitas = [];
        citasFiltradas = [];
      }
    }

    function guardarCitas() {
      localStorage.setItem('medagenda_appointments', JSON.stringify(todasLasCitas));
    }

    // ========================================
    // FUNCIONES DEL DASHBOARD
    // ========================================
    function actualizarEstadisticas() {
      const citasActivas = todasLasCitas.filter(c => !c.enEspera);
      const total = citasActivas.length;
      const emergencias = citasActivas.filter(c => c.priority === 'emergencia' || c.priority === 'muy-urgente').length;
      const urgentes = citasActivas.filter(c => c.priority === 'urgente').length;
      const enEspera = todasLasCitas.filter(c => c.enEspera === true).length;

      document.getElementById('totalCitas').textContent = total;
      document.getElementById('citasEmergencia').textContent = emergencias;
      document.getElementById('citasUrgentes').textContent = urgentes;
      document.getElementById('pacientesEspera').textContent = enEspera;
    }

    // ========================================
    // RENDERIZAR TABLA DE CITAS
    // ========================================
    function mostrarCitas() {
      const tbody = document.getElementById('tablaCitas');
      
      const citasActivas = citasFiltradas.filter(c => !c.enEspera);
      
      if (citasActivas.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px;">
              <p style="color: #999; font-size: 16px;">ğŸ“­ No hay citas que coincidan con los filtros</p>
            </td>
          </tr>
        `;
        return;
      }

      const citasOrdenadas = [...citasActivas].sort((a, b) => {
        const fechaA = new Date(a.date + 'T' + a.time);
        const fechaB = new Date(b.date + 'T' + b.time);
        return fechaA - fechaB;
      });

      tbody.innerHTML = citasOrdenadas.map(cita => {
        const prioridad = obtenerBadgePrioridad(cita.priority);
        const sintomas = cita.symptoms && cita.symptoms.length > 0 
          ? cita.symptoms.join(', ') 
          : 'Sin sÃ­ntomas';
        
        return `
          <tr>
            <td><strong>#${cita.id.substring(0, 8)}</strong></td>
            <td>${cita.name}</td>
            <td>${cita.phone}</td>
            <td>${formatearFecha(cita.date)} ${cita.time}</td>
            <td>${prioridad}</td>
            <td><span class="score-badge">${cita.score || 0}</span></td>
            <td style="max-width: 200px; font-size: 12px;">${sintomas}</td>
            <td>
              <button class="btn-action edit" onclick="editarCita('${cita.id}')" title="Editar">âœï¸</button>
              <button class="btn-action delete" onclick="cancelarCita('${cita.id}')" title="Cancelar">ğŸ—‘ï¸</button>
              <button class="btn-action waiting" onclick="moverAEspera('${cita.id}')" title="Lista de espera">â³</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ========================================
    // RENDERIZAR LISTA DE ESPERA
    // ========================================
    function mostrarListaEspera() {
      const container = document.getElementById('listaEspera');
      const enEspera = todasLasCitas.filter(c => c.enEspera === true);

      if (enEspera.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No hay pacientes en lista de espera</p>';
        return;
      }

      const ordenados = [...enEspera].sort((a, b) => (b.score || 0) - (a.score || 0));

      container.innerHTML = ordenados.map(cita => `
        <div class="waiting-card">
          <div class="waiting-card-header">
            <h4>${cita.name}</h4>
            ${obtenerBadgePrioridad(cita.priority)}
          </div>
          <p><strong>ğŸ“</strong> ${cita.phone}</p>
          <p><strong>ğŸ“‹</strong> ${cita.symptoms && cita.symptoms.length > 0 ? cita.symptoms.join(', ') : 'Sin sÃ­ntomas'}</p>
          <p><strong>ğŸ”¢ Score:</strong> ${cita.score || 0}</p>
          <div class="waiting-card-actions">
            <button class="btn outline small" onclick="reasignarCita('${cita.id}')">ğŸ“… Reasignar cita</button>
            <button class="btn outline small danger" onclick="cancelarCita('${cita.id}')">âŒ Eliminar</button>
          </div>
        </div>
      `).join('');
    }

    // ========================================
    // FUNCIONES DE FILTROS
    // ========================================
    function filtrarCitas() {
      const nombre = document.getElementById('filtroNombre').value.toLowerCase();
      const fecha = document.getElementById('filtroFecha').value;
      const prioridad = document.getElementById('filtroPrioridad').value;

      citasFiltradas = todasLasCitas.filter(cita => {
        const coincideNombre = !nombre || cita.name.toLowerCase().includes(nombre);
        const coincideFecha = !fecha || cita.date === fecha;
        const coincidePrioridad = !prioridad || cita.priority === prioridad;
        return coincideNombre && coincideFecha && coincidePrioridad;
      });

      mostrarCitas();
    }

    function limpiarFiltros() {
      document.getElementById('filtroNombre').value = '';
      document.getElementById('filtroFecha').value = '';
      document.getElementById('filtroPrioridad').value = '';
      citasFiltradas = [...todasLasCitas];
      mostrarCitas();
    }

    // ========================================
    // EDITAR CITA
    // ========================================
    function editarCita(id) {
      citaEditando = todasLasCitas.find(c => c.id === id);
      if (!citaEditando) return;

      document.getElementById('editarId').value = citaEditando.id;
      document.getElementById('editarNombre').value = citaEditando.name;
      document.getElementById('editarTelefono').value = citaEditando.phone;
      document.getElementById('editarFecha').value = citaEditando.date;
      document.getElementById('editarHora').value = citaEditando.time;
      document.getElementById('editarPrioridad').value = citaEditando.priority;
      document.getElementById('editarSintomas').value = citaEditando.symptoms ? citaEditando.symptoms.join(', ') : '';

      document.getElementById('modalEditar').style.display = 'flex';
    }

    function guardarEdicion() {
      const id = document.getElementById('editarId').value;
      const index = todasLasCitas.findIndex(c => c.id === id);
      
      if (index === -1) return;

      todasLasCitas[index].name = document.getElementById('editarNombre').value;
      todasLasCitas[index].phone = document.getElementById('editarTelefono').value;
      todasLasCitas[index].date = document.getElementById('editarFecha').value;
      todasLasCitas[index].time = document.getElementById('editarHora').value;
      todasLasCitas[index].priority = document.getElementById('editarPrioridad').value;
      
      const sintomasTexto = document.getElementById('editarSintomas').value;
      todasLasCitas[index].symptoms = sintomasTexto ? sintomasTexto.split(',').map(s => s.trim()) : [];

      guardarCitas();
      cerrarModal();
      cargarTodo();
      
      alert('âœ… Cita actualizada correctamente');
    }

    function cerrarModal() {
      document.getElementById('modalEditar').style.display = 'none';
      citaEditando = null;
    }

    // ========================================
    // CANCELAR CITA
    // ========================================
    function cancelarCita(id) {
      const cita = todasLasCitas.find(c => c.id === id);
      if (!cita) return;

      if (confirm(`Â¿Eliminar la cita de ${cita.name}?`)) {
        todasLasCitas = todasLasCitas.filter(c => c.id !== id);
        guardarCitas();
        cargarTodo();
        alert('âœ… Cita eliminada correctamente');
      }
    }

    // ========================================
    // MOVER A LISTA DE ESPERA
    // ========================================
    function moverAEspera(id) {
      const index = todasLasCitas.findIndex(c => c.id === id);
      if (index === -1) return;

      if (confirm(`Â¿Mover a ${todasLasCitas[index].name} a la lista de espera?`)) {
        todasLasCitas[index].enEspera = true;
        guardarCitas();
        cargarTodo();
        alert('âœ… Paciente movido a lista de espera');
      }
    }

    // ========================================
    // REASIGNAR CITA
    // ========================================
    function reasignarCita(id) {
      const index = todasLasCitas.findIndex(c => c.id === id);
      if (index === -1) return;

      const nuevaFecha = prompt('Ingresa la nueva fecha (YYYY-MM-DD):');
      if (!nuevaFecha) return;

      const nuevaHora = prompt('Ingresa la nueva hora (HH:MM):');
      if (!nuevaHora) return;

      todasLasCitas[index].date = nuevaFecha;
      todasLasCitas[index].time = nuevaHora;
      todasLasCitas[index].enEspera = false;

      guardarCitas();
      cargarTodo();
      alert('âœ… Cita reasignada correctamente');
    }

    // ========================================
    // EXPORTAR CITAS
    // ========================================
    function exportarCitas() {
      const dataStr = JSON.stringify(todasLasCitas, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `medagenda_citas_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      
      URL.revokeObjectURL(url);
      alert('âœ… Citas exportadas correctamente');
    }

    // ========================================
    // GENERAR REPORTE
    // ========================================
    function generarReporte() {
      const total = todasLasCitas.filter(c => !c.enEspera).length;
      const emergencias = todasLasCitas.filter(c => !c.enEspera && (c.priority === 'emergencia' || c.priority === 'muy-urgente')).length;
      const urgentes = todasLasCitas.filter(c => !c.enEspera && c.priority === 'urgente').length;
      const noUrgentes = todasLasCitas.filter(c => !c.enEspera && c.priority === 'no-urgente').length;
      const enEspera = todasLasCitas.filter(c => c.enEspera === true).length;

      alert(`ğŸ“Š REPORTE DE CITAS\n\n` +
            `Total de citas activas: ${total}\n` +
            `Emergencias/Muy urgentes: ${emergencias}\n` +
            `Urgentes: ${urgentes}\n` +
            `No urgentes: ${noUrgentes}\n` +
            `En lista de espera: ${enEspera}`);
    }

    // ========================================
    // LIMPIAR TODAS LAS CITAS
    // ========================================
    function limpiarTodasCitas() {
      if (confirm('âš ï¸ Â¿EstÃ¡s seguro de eliminar TODAS las citas?\n\nEsta acciÃ³n no se puede deshacer.')) {
        if (confirm('ğŸš¨ CONFIRMACIÃ“N FINAL: Se borrarÃ¡n todas las citas permanentemente.')) {
          todasLasCitas = [];
          guardarCitas();
          cargarTodo();
          alert('âœ… Todas las citas han sido eliminadas');
        }
      }
    }

    // ========================================
    // CERRAR SESIÃ“N
    // ========================================
    function cerrarSesion() {
      if (confirm('Â¿Cerrar sesiÃ³n?')) {
        sessionStorage.removeItem('medagenda_user');
        sessionStorage.removeItem('medagenda_logged');
        sessionStorage.removeItem('medagenda_role');
        window.location.href = 'login.html';
      }
    }

    // ========================================
    // FUNCIONES AUXILIARES
    // ========================================
    function obtenerBadgePrioridad(priority) {
      const badges = {
        'emergencia': '<span class="badge emergency">ğŸ”´ Emergencia</span>',
        'muy-urgente': '<span class="badge urgent">ğŸŸ  Muy urgente</span>',
        'urgente': '<span class="badge moderate">ğŸŸ¡ Urgente</span>',
        'no-urgente': '<span class="badge normal">ğŸ”µ No urgente</span>',
        'control': '<span class="badge low">âšª Control</span>'
      };
      return badges[priority] || '<span class="badge">â“ Sin clasificar</span>';
    }

    function formatearFecha(fecha) {
      const [year, month, day] = fecha.split('-');
      return `${day}/${month}/${year}`;
    }

    // ========================================
    // CARGAR TODO
    // ========================================
    function cargarTodo() {
      cargarCitas();
      citasFiltradas = [...todasLasCitas];
      actualizarEstadisticas();
      mostrarCitas();
      mostrarListaEspera();
    }

    // ========================================
    // INICIALIZAR AL CARGAR LA PÃGINA
    // ========================================
    window.addEventListener('DOMContentLoaded', cargarTodo);

    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
      const modal = document.getElementById('modalEditar');
      if (event.target === modal) {
        cerrarModal();
      }
    };
  </script>
</body>
</html>