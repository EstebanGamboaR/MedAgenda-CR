<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendar Cita - MedAgenda-CR</title>
  <link rel="stylesheet" href="css/style.css?v=2.0">
</head>
<body>
  <!-- NavegaciÃ³n -->
  <nav class="navbar">
    <div class="container">
      <div class="nav-brand">
        <h1>ğŸ¥ MedAgenda-CR</h1>
      </div>
      <ul class="nav-menu">
        <li><a href="index.html" class="nav-link">Inicio</a></li>
        <li><a href="agendar.html" class="nav-link active">Agendar cita</a></li>
        <li><a href="login.html" class="nav-link">Panel administrativo</a></li>
      </ul>
    </div>
  </nav>

  <!-- Formulario de agendamiento -->
  <section style="padding: 3rem 0; background: var(--beige-100);">
    <div class="container">
      <div class="appointment-form">
        <h2 style="text-align: center; font-size: 2.5rem; color: var(--hospital-blue-dark); margin-bottom: 2rem;">
          ğŸ“‹ Agendar Nueva Cita
        </h2>
        
        <form id="appointmentForm">
          <!-- SECCIÃ“N 1: Datos personales -->
          <div class="form-section">
            <h3>ğŸ‘¤ InformaciÃ³n del paciente</h3>
            
            <div class="form-group">
              <label for="nombre">Nombre completo *</label>
              <input type="text" id="nombre" name="nombre" required placeholder="Ej: Juan PÃ©rez Mora">
            </div>
            
            <div class="form-group">
              <label for="telefono">TelÃ©fono *</label>
              <input type="tel" id="telefono" name="telefono" required placeholder="Ej: 8888-8888" pattern="[0-9]{4}-[0-9]{4}">
            </div>
            
            <div class="form-group">
              <label for="email">Correo electrÃ³nico (opcional)</label>
              <input type="email" id="email" name="email" placeholder="Ej: ejemplo@email.com">
            </div>
          </div>

          <!-- SECCIÃ“N 2: InformaciÃ³n de la cita -->
          <div class="form-section">
            <h3>ğŸ“… Fecha y hora deseada</h3>
            
            <div class="form-group">
              <label for="fecha">Fecha preferida *</label>
              <input type="date" id="fecha" name="fecha" required>
            </div>
            
            <div class="form-group">
              <label for="hora">Hora preferida *</label>
              <input type="time" id="hora" name="hora" required min="07:00" max="16:00">
            </div>
          </div>

          <!-- SECCIÃ“N 3: Triage (sÃ­ntomas) -->
          <div class="form-section">
            <h3>ğŸ©º EvaluaciÃ³n de sÃ­ntomas (Triage)</h3>
            <p style="color: var(--gray-500); margin-bottom: 1rem;">
              Selecciona los sÃ­ntomas que presentas. Esto ayudarÃ¡ a priorizar tu cita segÃºn urgencia mÃ©dica.
            </p>
            
            <div class="checkbox-group">
              <div class="checkbox-item">
                <input type="checkbox" id="fiebre" name="sintomas" value="fiebre">
                <label for="fiebre">ğŸŒ¡ï¸ Fiebre (mÃ¡s de 38Â°C)</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="dolor-pecho" name="sintomas" value="dolor-pecho">
                <label for="dolor-pecho">ğŸ’” Dolor en el pecho</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="dificultad-respirar" name="sintomas" value="dificultad-respirar">
                <label for="dificultad-respirar">ğŸ˜®â€ğŸ’¨ Dificultad para respirar</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="sangrado" name="sintomas" value="sangrado">
                <label for="sangrado">ğŸ©¸ Sangrado abundante</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="dolor-abdominal" name="sintomas" value="dolor-abdominal">
                <label for="dolor-abdominal">ğŸ¤° Dolor abdominal intenso</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="mareos" name="sintomas" value="mareos">
                <label for="mareos">ğŸ˜µ Mareos o pÃ©rdida de conciencia</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="lesion" name="sintomas" value="lesion">
                <label for="lesion">ğŸ¤• LesiÃ³n por accidente</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="embarazo" name="sintomas" value="embarazo">
                <label for="embarazo">ğŸ¤° Complicaciones de embarazo</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="tos" name="sintomas" value="tos">
                <label for="tos">ğŸ˜· Tos persistente</label>
              </div>
              
              <div class="checkbox-item">
                <input type="checkbox" id="control" name="sintomas" value="control">
                <label for="control">ğŸ“‹ Control de rutina / Chequeo preventivo</label>
              </div>
            </div>
          </div>

          <!-- Display de prioridad calculada -->
          <div id="prioridadDisplay" class="priority-display" style="display: none;">
            <h4>Prioridad asignada:</h4>
            <p id="prioridadTexto"></p>
            <p id="scoreTexto" style="font-size: 1.2rem; margin-top: 0.5rem;"></p>
          </div>

          <!-- BotÃ³n de envÃ­o -->
          <button type="submit" class="btn primary large" style="width: 100%; margin-top: 2rem;">
            âœ… Agendar mi cita
          </button>
        </form>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h4>MedAgenda-CR</h4>
          <p>Sistema de gestiÃ³n de citas para EBAIS de Costa Rica</p>
        </div>
        <div class="footer-section">
          <h4>Enlaces</h4>
          <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="agendar.html">Agendar cita</a></li>
            <li><a href="login.html">Panel administrativo</a></li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <script>
    // ========================================
    // CONFIGURAR FECHA MÃNIMA (HOY)
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      const fechaInput = document.getElementById('fecha');
      const hoy = new Date().toISOString().split('T')[0];
      fechaInput.min = hoy;
      fechaInput.value = hoy;
    });

    // ========================================
    // SISTEMA DE TRIAGE - CÃLCULO DE PRIORIDAD
    // ========================================
    const sintomasCheckboxes = document.querySelectorAll('input[name="sintomas"]');
    const prioridadDisplay = document.getElementById('prioridadDisplay');
    const prioridadTexto = document.getElementById('prioridadTexto');
    const scoreTexto = document.getElementById('scoreTexto');

    // Puntajes por sÃ­ntoma
    const puntajes = {
      'dolor-pecho': 100,
      'dificultad-respirar': 90,
      'sangrado': 85,
      'mareos': 80,
      'dolor-abdominal': 70,
      'embarazo': 75,
      'lesion': 65,
      'fiebre': 50,
      'tos': 30,
      'control': 10
    };

    sintomasCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', calcularPrioridad);
    });

    function calcularPrioridad() {
      const seleccionados = Array.from(sintomasCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      if (seleccionados.length === 0) {
        prioridadDisplay.style.display = 'none';
        return;
      }

      // Calcular score total
      let score = 0;
      seleccionados.forEach(sintoma => {
        score += puntajes[sintoma] || 0;
      });

      // Determinar nivel de prioridad
      let nivel, emoji, descripcion;
      if (score >= 80) {
        nivel = 'emergencia';
        emoji = 'ğŸ”´';
        descripcion = 'EMERGENCIA - AtenciÃ³n inmediata';
      } else if (score >= 60) {
        nivel = 'muy-urgente';
        emoji = 'ğŸŸ ';
        descripcion = 'MUY URGENTE - AtenciÃ³n prioritaria';
      } else if (score >= 40) {
        nivel = 'urgente';
        emoji = 'ğŸŸ¡';
        descripcion = 'URGENTE - AtenciÃ³n en 24-48 horas';
      } else if (score >= 20) {
        nivel = 'no-urgente';
        emoji = 'ğŸ”µ';
        descripcion = 'NO URGENTE - AtenciÃ³n en 3-7 dÃ­as';
      } else {
        nivel = 'control';
        emoji = 'âšª';
        descripcion = 'CONTROL - Cita programada regular';
      }

      // Mostrar resultado
      prioridadDisplay.style.display = 'block';
      prioridadTexto.textContent = `${emoji} ${descripcion}`;
      scoreTexto.textContent = `Score de triage: ${score} puntos`;
      
      // Guardar en el formulario (campo oculto)
      let hiddenPrioridad = document.getElementById('prioridadCalculada');
      if (!hiddenPrioridad) {
        hiddenPrioridad = document.createElement('input');
        hiddenPrioridad.type = 'hidden';
        hiddenPrioridad.id = 'prioridadCalculada';
        hiddenPrioridad.name = 'prioridad';
        document.getElementById('appointmentForm').appendChild(hiddenPrioridad);
      }
      hiddenPrioridad.value = nivel;

      let hiddenScore = document.getElementById('scoreCalculado');
      if (!hiddenScore) {
        hiddenScore = document.createElement('input');
        hiddenScore.type = 'hidden';
        hiddenScore.id = 'scoreCalculado';
        hiddenScore.name = 'score';
        document.getElementById('appointmentForm').appendChild(hiddenScore);
      }
      hiddenScore.value = score;
    }

    // ========================================
    // ENVIAR FORMULARIO
    // ========================================
    document.getElementById('appointmentForm').addEventListener('submit', function(e) {
      e.preventDefault();

      // Recolectar datos
      const nombre = document.getElementById('nombre').value.trim();
      const telefono = document.getElementById('telefono').value.trim();
      const email = document.getElementById('email').value.trim();
      const fecha = document.getElementById('fecha').value;
      const hora = document.getElementById('hora').value;
      
      const sintomasSeleccionados = Array.from(sintomasCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      const prioridad = document.getElementById('prioridadCalculada')?.value || 'control';
      const score = parseInt(document.getElementById('scoreCalculado')?.value || '0');

      // Validar que seleccionÃ³ al menos un sÃ­ntoma
      if (sintomasSeleccionados.length === 0) {
        alert('âš ï¸ Por favor selecciona al menos un sÃ­ntoma o motivo de consulta');
        return;
      }

      // Crear objeto de cita
      const cita = {
        id: 'CITA-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
        name: nombre,
        phone: telefono,
        email: email,
        date: fecha,
        time: hora,
        symptoms: sintomasSeleccionados,
        priority: prioridad,
        score: score,
        createdAt: new Date().toISOString(),
        enEspera: false
      };

      // Guardar en localStorage
      let citas = JSON.parse(localStorage.getItem('medagenda_appointments') || '[]');
      citas.push(cita);
      localStorage.setItem('medagenda_appointments', JSON.stringify(citas));

      // Mostrar confirmaciÃ³n
      alert(`âœ… Â¡Cita agendada exitosamente!\n\n` +
            `ğŸ“‹ ID: ${cita.id.substring(0, 12)}...\n` +
            `ğŸ‘¤ Paciente: ${nombre}\n` +
            `ğŸ“… Fecha: ${fecha}\n` +
            `ğŸ• Hora: ${hora}\n` +
            `âš•ï¸ Prioridad: ${prioridad.toUpperCase()}\n` +
            `ğŸ”¢ Score: ${score}\n\n` +
            `RecibirÃ¡s recordatorios por WhatsApp/SMS antes de tu cita.\n\n` +
            `Para consultas: 2000-0000`);

      // Limpiar formulario
      document.getElementById('appointmentForm').reset();
      prioridadDisplay.style.display = 'none';

      // Redirigir despuÃ©s de 2 segundos
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 2000);
    });
  </script>
</body>
</html>